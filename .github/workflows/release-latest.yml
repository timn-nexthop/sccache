name: Release Latest

on:
  push:
    branches:
      - main

jobs:
  build-and-release:
    name: Build and Release Latest
    runs-on: ubuntu-22.04
    container: 
      image: messense/rust-musl-cross:x86_64-musl
    permissions:
      contents: write
    steps:
      - name: Clone repository
        uses: actions/checkout@v5

      - name: Extract version from Cargo.toml
        id: version
        run: |
          VERSION=$(cargo pkgid | cut -d# -f2 | cut -d: -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Install zstd
        run: |
          apt-get update
          apt-get install -y zstd

      - name: Build static binary
        run: |
          cargo build --locked --release --bin sccache --target x86_64-unknown-linux-musl --features=openssl/vendored
          zstd -T0 -19 target/x86_64-unknown-linux-musl/release/sccache -o sccache-${{ steps.version.outputs.version }}-x86_64-unknown-linux-musl.zst
          cargo build --locked --release --no-default-features --features="dist-server" --bin sccache-dist --target x86_64-unknown-linux-musl --features=openssl/vendored
          zstd -T0 -19 target/x86_64-unknown-linux-musl/release/sccache-dist -o sccache-dist-${{ steps.version.outputs.version }}-x86_64-unknown-linux-musl.zst
        env:
          CARGO_PROFILE_RELEASE_LTO: true

      - name: Verify binaries
        run: |
          target/x86_64-unknown-linux-musl/release/sccache --help
          target/x86_64-unknown-linux-musl/release/sccache-dist --help

      - name: Generate SHA256 checksum
        run: |
          sha256sum sccache-${{ steps.version.outputs.version }}-x86_64-unknown-linux-musl.zst > sccache-${{ steps.version.outputs.version }}-x86_64-unknown-linux-musl.zst.sha256
          sha256sum sccache-dist-${{ steps.version.outputs.version }}-x86_64-unknown-linux-musl.zst > sccache-dist-${{ steps.version.outputs.version }}-x86_64-unknown-linux-musl.zst.sha256

      - name: Create or Update Latest Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            Release v${{ steps.version.outputs.version }} from main branch

            Commit: ${{ github.sha }}
            Build Date: ${{ github.event.head_commit.timestamp }}

            This is an automatically generated release with static x86_64-unknown-linux-musl binaries.
          files: |
            sccache-${{ steps.version.outputs.version }}-x86_64-unknown-linux-musl.zst
            sccache-${{ steps.version.outputs.version }}-x86_64-unknown-linux-musl.zst.sha256
            sccache-dist-${{ steps.version.outputs.version }}-x86_64-unknown-linux-musl.zst
            sccache-dist-${{ steps.version.outputs.version }}-x86_64-unknown-linux-musl.zst.sha256
          prerelease: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
