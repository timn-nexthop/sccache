name: Release Latest

on:
  push:
    branches:
      - main

jobs:
  build-and-release:
    name: Build and Release Latest
    runs-on: ubuntu-22.04
    container: 
      image: messense/rust-musl-cross:x86_64-musl
    permissions:
      contents: write
    steps:
      - name: Clone repository
        uses: actions/checkout@v5

      - name: Install zstd
        run: apk add --no-cache zstd

      - name: Build static binary
        run: cargo build --locked --release --bin sccache --target x86_64-unknown-linux-musl --features=openssl/vendored
        env:
          CARGO_PROFILE_RELEASE_LTO: true

      - name: Compress binary with zstd
        run: |
          zstd -19 target/x86_64-unknown-linux-musl/release/sccache -o sccache-latest-x86_64-unknown-linux-musl.zst
          chmod +x target/x86_64-unknown-linux-musl/release/sccache

      - name: Generate SHA256 checksum
        run: |
          sha256sum sccache-latest-x86_64-unknown-linux-musl.zst > sccache-latest-x86_64-unknown-linux-musl.zst.sha256

      - name: Create or Update Latest Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Build
          body: |
            Latest build from main branch
            
            Commit: ${{ github.sha }}
            Build Date: ${{ github.event.head_commit.timestamp }}
            
            This is an automatically generated release with the latest static x86_64-unknown-linux-musl binary (zstd compressed).
            
            To use:
            ```bash
            # Download and decompress
            curl -L https://github.com/mozilla/sccache/releases/download/latest/sccache-latest-x86_64-unknown-linux-musl.zst -o sccache.zst
            zstd -d sccache.zst
            chmod +x sccache
            ```
          files: |
            sccache-latest-x86_64-unknown-linux-musl.zst
            sccache-latest-x86_64-unknown-linux-musl.zst.sha256
          prerelease: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
